#!/usr/bin/env zsh

source $ZSH/lib/_helpers

HOST="`hostname`"
DIR="$HOME/.dotfiles/homebrew/lists/$HOST"
mkdir -p "$DIR"
cd "$DIR"

echo "Ensuring brew is up to date first.."
brew update

echo "Updating list files for $HOST.."
echo "  Dumping Brew list.."
brew list > brew.$HOST.list
echo "  Dumping Brew taps.."
brew tap > brew-tap.$HOST.list
echo "  Dumping Brew cask list.."
brew cask list > brew-cask.$HOST.list

echo "  Dumping Mas list.."
mas list > mas.$HOST.list

echo "  Dumping Brew bundle.."
brew bundle dump --force --file="Brewfile.$HOST.list"

# Atom
echo "  Dumping Atom.."
if is_installed "apm" 1> /dev/null; then
  apm list --installed --bare > apm.$HOST.list
else
  echo "    [WARNING] 'apm' not found, assuming Atom isn't installed. Skipping."
fi

# Node
echo "  Dumping NPM.."
npm list -g --depth=0 > npm.$HOST.list

# Ruby
echo "  Dumping Ruby Gems.."
ruby -e 'puts Gem::Specification.all_names' > gem.$HOST.list

# Python
echo "  Dumping Python.."
source "$HOME/.dotfiles/python/python-versions.zsh"
eval "$(pyenv init -)"

echo "    Python (System version)"
pyenv shell system
pip list > pip.$HOST.system.list

echo "    Python 2.x"
pyenv shell $PYTHON_2X_VER
pip list > pip.$HOST.list

echo "    Python 3.x"
pyenv shell $PYTHON_3X_VER
pip3 list > pip3.$HOST.list

pyenv shell --unset

# Go
echo "  Dumping Golang bin/ folder"
echo "$(cd ${GOPATH%%:*}/bin && ls)" > go.$HOST.list

# echo Staging in git..
# git add brew.list
# git add brew-tap.list
# git add brew-cask.list

# echo Diffs..
# git diff brew.list
# git diff brew-tap.list
# git diff brew-cask.list
# git diff Brewfile.list
# git diff mas.list
git status
